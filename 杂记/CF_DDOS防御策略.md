# 使用Cloudflare进行DDoS防护

## 实现方法
1. 在cloudflare中使用cdn节点的方式实现(DNS解析中使用小黄云)  

**出现的问题**：  
为了防止ip地址和域名之间的直接联系即通过`ip:port`的方法对网站进行访问从而导致源站ip泄露  

2. 我们可以在云服务器的提供商处使用`IP白名单`策略实现只允许Cloudflare的CDN节点来访问我们的网站屏蔽掉其他的一切无关访问特别是`屏蔽掉网络空间测绘的访问`  

**实现步骤**：
在安全组中`创建安全组`-`取消勾选允许访问所有端口`-`添加入站规则`-`添加规则`  
<pre>
类型：IPv4  协议：tcp  端口：80/443(看你网站使用的是哪个)  IP来源：(这里填写Cloudflare CDN节点的IP)  备注的话可以选填
</pre>
CF的所有CDN节点的IP地址：https://www.cloudflare.com/zh-cn/ips/  
<pre>
IPv4
103.21.244.0/22
103.22.200.0/22
103.31.4.0/22
104.16.0.0/13
104.24.0.0/14
108.162.192.0/18
131.0.72.0/22
141.101.64.0/18
162.158.0.0/15
172.64.0.0/13
173.245.48.0/20
188.114.96.0/20
190.93.240.0/20
197.234.240.0/22
198.41.128.0/17

IPv6
2400:cb00::/32
2606:4700::/32
2803:f800::/32
2405:b500::/32
2405:8100::/32
2a06:98c0::/29
2c0f:f248::/32
</pre>

**注意**：这里记得开放你的ssh端口22的规则  
然后重新关联一下安全组就可以了

如果服务器提供商并没有给你的服务器提供可视化的安全组策略面板那么不妨试试这个项目：  
https://github.com/moreKing/web-firewall  
web-firewall基于golang+vue3 开发的Web Linux防火墙，前端使用SoybeanAdmin框架，后端使用goframe2，数据库支持 sqlite3(默认)/postgresql ，它可以在Linux系统中基于nfatables用于替代firewalld工具  

这里尝试一下使用你的ip地址来访问你的网站如果访问不到那就说明生效了  
这样就可以抵挡住某些网络测绘工具的扫描了  
使用域名访问一下发现是可以进行访问的  
到现在位置我们可以扛住`网络层`还有`传输层`的DDoS攻击  

**CF防火墙WAF实现对应用层的扛DDos攻击**：  
点击你的`域名`-`安全性`-`WAF`-`自定义规则`-`创建规则`  
<pre>
规则名称：恶意请求
字段：威胁分数
运算符：大于或等于
值：5
表达式预览`(cf.threat_score ge 5)`
选择操作：托管质询
保存
</pre>
<pre>
规则名称：屏蔽国外
字段：国家/地区
运算符：不等于
值：China
表达式预览`(ip.src.country ne "CN")`
选择操作：阻止
保存
</pre>
在`速率规则限制`中进行配置：  
`我是关闭这项的`
<pre>
规则名称：IP访问限制
字段：URL路径
运算符：通配符
值：*   (*表示保护整个网站)
表达式预览(http.request.uri.path wildcard "*")
当速率超过… 请求： 100 (100或者150)期间： 10秒钟
然后采取措施… 阻止
持续时间达… 10秒钟
</pre>

**修改安全级别**：  
`我一般选择：中级`  
在`域名`-`安全性`-`设置`-`安全级别处选择最高的I'm Under Attack!`  
即访问网站的所有请求必须全部通过CF的人机验证才能到达你的网站

对于个人博客等网站推荐使用静态网页部署的服务比如Github Pages,Cloudflare Pages,Vercel等...