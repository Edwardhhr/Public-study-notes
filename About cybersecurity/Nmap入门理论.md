# Nmap入门理论

## 端口扫描
直接使用 `nmap + <目标>` 进行端口扫描只会扫描`1000个常见的TCP端口`，即`忽略了UDP`协议的应用了  
另外TCP有`65535`个端口所以理论上nmap忽略了6万多个额外的TCP端口

扫描所有TCP端口
```bash
nmap -p- <目标IP/域名>
```
扫描指定的TCP端口
```bash
nmap -p <端口号> <目标IP/域名>
```

使用 `-s + 不同的字母` 表示不同形式的扫描  
扫描TCP端口
```bash
nmap -sT <目标IP/域名>
```
扫描UDP端口
```bash
nmap -sU <目标IP/域名>
```


## TCP连接扫描和端口状态
如果应用使用了TCP协议正常来说会进行三次握手再发送数据，三次握手也就是SYN,SYN/ACK和ACK  
`nmap -sT`同样是会完成握手动作的只不过当目标主机发送数据过来的时候不会发送正常的数据而是会发送RST进行会话的中断，注意正常结束TCP会话是需要发送FIN的  
SYN, ACK, RST, FIN 都是TCP数据段里的标志，这些标志可以用来表示会话的状态  
使用`nmap -sT`会存在一定的副作用，首先因为需要完成握手的整个过程因此比较花时间其次，目标主机通常会对完成握手的会话进行日志的记录扫描的时候容易留下痕迹  
当然我们也不能完全否定"nmap-sT"的作用因为只要目标主机发送了SYN/ACK包过来nmap就可以标记这个端口是open开放状态的了如果目标主机返回的不是SYN/ACK包，而是RST包nmap则会记录这个端口为closed关闭状态但如果nmap发送SYN包以后，没有收到回复呢?那就很有可能被防火墙阻挡了此时nmap就会标记端口为filtered被过滤状态了  


## SYN扫描
```bash
nmap -sS <目标>
```
为了不留下明显的痕迹需要用更高级一点的`nmap -sS <目标>`当收到目标主机发送过来的SYN/ACK的时候nmap不会走完整个TCP握手过程不会发送FIN，而是在这里就发送RST相当于你打电话给别人别人接了你的电话，并且进行确认然后你就找个理由挂电话了虽然没有继续通话但起码你知道对方的信息了  
在收到自标主机的SYN/ACK的时候其实也是确定了访问的这入端口是开放的，如果收到的不是SYN/ACK，而是RST则表示目标主机的这个端口关闭了如果连RST都没有收到，什么都没大概率是被防火墙拦截了，也就是会标记为“过滤”另外收到ICMP报错消息，也是会标记为“过滤”   
`nmap -ss <目标>`也被称为半连接扫描或半开扫描还可以被叫做SYN扫描，对于nmap的TCP扫描来说nmap的SYN扫描能够更快达到目的，并且不容易被保存到日志中  
但是在进行SYN扫描的时候要加上sudo权限  
如果直接用nmap进行扫描，默认会进行TCP连接扫描  
但如果加上sudo，默认则是用SYN半连接进行扫描  


## UDP扫描
扫描常用的UDP端口
```bash
nmap -sUV --top-ports <目标>
```
扫描常用的100个UDP端口
```bash
nmap -sUV --top-ports 100 <目标>
```
UDP只能依靠自标主机的回复作出判断但问题是对于大部分端口，nmap发送的数据包没有负载对方相当于收到一个空红包这样的数据包一般不会收到目标主机的回复另外，如果防火墙丢了你的包，一般也不会作出回复因此在使用UDP扫描的时候会经常看到open和filtered一起显示此时端口可能开放了，也可能被防火墙阻挡了那如果UDP包收到回复了呢?此时并不是有鬼而是如果UDP端口关闭了一般会回复类型和代码为3的ICMP包那我们如何判断UDP端口是开放还是被过滤了呢？小技巧就是使用`nmap -sUV`这里加的V会进行版本扫描nmap会在open|filtered的端口中做探测确认运行的软件版本从而明确端口为开放的状态使用UDP还有一个痛点就是慢毕竟目标主机一般不会回复没有负载的UDP包加上防火墙以及限流的关系导致诸多不确定因素因此同一端口nmap一般会出现多次探测请求的情况UDP扫描最好配合其它选项进行探测`例如--top-ports`意思是扫描常用的端口`nmap -sUV --top-ports <目标>`如果加上数字100就是扫描常用的100个UDP端口`nmap -sUV --top-ports 100 <目标>`以此来增加UDP端口扫描的实用性  

## ICMP和Ping扫描

```bash
nmap -sn <目标>
```
可以用"-"来表示IP的范围  
绕过防火墙的阻挡不使用Ping
```bash
nmap -Pn <目标>
```
主机发现也是Nmap的一个重点，一般是先发现有哪些正在运行的主机再探测运行主机有哪些运行的服务或者开放了什么端口，在没有学习Nmap之前我们一般会用ping命令来查看是否和目标主机连通从而确定目标主机是否在运行在nmap里直接用`nmap -sn <目标>`就可以进行Ping扫描了和直接用ping命令不同的是单独的ping命令，一次只能ping一个地址而nmap在这里可以用"-"来表示IP的范围当然也可以用CIDR的方式来指明范围不管是本地还是远程的网络我们都可以用nmap -sn来进行不同的是扫描本地网络实际上用了ARP协议进行请求扫描远程网络则用了ICMP协议，还会利用TCP SYN和TCP ACK进行主机发现可是遇到用windows服务器就要注意了比如像2016，2019，2022这样的版本防火墙默认会屏蔽掉所有ICMP包如果继续nmap -sn就会进入死胡同了此时`nmap -Pn <目标>`会更为实用-Pn相当于"No Ping"，不要Ping了以此来绕过防火墙的阻挡但是这个命令非常耗时间因为nmap会假设目标主机是正在运行的如果目标主机没有在运行会导致nmap进行重复探测